---
layout: advisory
title: 'CVE-2021-43805 (solidus_core): ReDos vulnerability on guest checkout email
  validation'
comments: false
categories:
- solidus_core
advisory:
  gem: solidus_core
  cve: 2021-43805
  ghsa: qxmr-qxh6-2cc9
  url: https://github.com/solidusio/solidus/security/advisories/GHSA-qxmr-qxh6-2cc9
  title: ReDos vulnerability on guest checkout email validation
  date: 2021-12-07
  description: |
    ### Impact
    Denial of service vulnerability that could be exploited during a guest checkout.
    The regular expression used to validate a guest order's email was subject to
    exponential backtracking through a fragment like `a.a.`.

    Before the patch, it can be reproduced in the console like this:

    ```ruby
    irb(main)> Spree::EmailValidator::EMAIL_REGEXP.match "a@a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.a.@"
    processing time: 54.293660s
    => nil
    ```

    To reproduce in the browser, fill in the "Customer Email" field with that fake
    email address during a guest checkout. Before that, you should open the browser
    dev tools and change the `type` attribute for that field from `email` to `text`.
    After entering a fake address and pressing the "Save & Continue" button, the
    browser will take a long term to perform the request before showing an error
    message for the invalid address. Eventually, making the email string even longer
    could lead to the exhaustion of server resources.

    ### Patches
    Versions 3.1.4, 3.0.4, and 2.11.13 have been patched to use a different regular
    expression.

    There's an improbable chance that some orders in your system end up having
    associated an email address that is no longer valid. We've added a task to check
    precisely that:

    ```bash
    bin/rails solidus:check_orders_with_invalid_email
    ```

    The above will print information for every affected order if any.

    ### Workarounds

    If a prompt upgrade is not an option, please, add the following to
    `config/application.rb`:

    ```ruby
    config.after_initialize do
      Spree::EmailValidator.send(:remove_const, :EMAIL_REGEXP)
      Spree::EmailValidator::EMAIL_REGEXP = URI::MailTo::EMAIL_REGEXP
    end
    ```
  cvss_v3: 7.5
  patched_versions:
  - "~> 2.11.13"
  - "~> 3.0.4"
  - ">= 3.1.4"
  related:
    url:
    - https://github.com/solidusio/solidus/commit/6be174c955fad84017ca67589c676526bc5ade71
    - https://en.wikipedia.org/wiki/ReDoS
    - https://snyk.io/blog/redos-and-catastrophic-backtracking/
---
